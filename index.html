<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Girl OSK — Consistency Chart</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b0f0d" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="E-Girl OSK" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #0b0f0d;
      --card: #111814;
      --card2: #0f1512;
      --text: #e7e4d8;
      --muted: #b9b29a;
      --gold: #c7a44b;
      --green: #2a6a4f;
      --line: rgba(199,164,75,0.25);
      --shadow: 0 10px 30px rgba(0,0,0,0.45);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    html, body{ height: 100%; }

    body{
      margin:0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(42,106,79,0.25), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(199,164,75,0.18), transparent 60%),
        var(--bg);
      color: var(--text);
    }

    .wrap{ max-width: 1200px; margin: 22px auto; padding: 0 14px 34px; }

    .top{
      display:flex; gap:14px; align-items:flex-end; justify-content:space-between; flex-wrap: wrap;
      margin-bottom: 12px;
    }

    h1{ margin:0; font-weight: 750; letter-spacing: 0.3px; }
    .sub{ margin:6px 0 0; color: var(--muted); font-family: var(--mono); font-size: 12px; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .grid{ display:grid; grid-template-columns: 1.25fr 0.75fr; gap: 14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .row{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }

    input[type="text"], select, input[type="date"]{
      background: var(--card2);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    input[type="text"]{ min-width: 220px; flex: 1; }

    button{
      background: linear-gradient(180deg, rgba(199,164,75,0.22), rgba(199,164,75,0.10));
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 650;
    }
    button:hover{ border-color: rgba(199,164,75,0.55); }

    .tiny{ color: var(--muted); font-size: 12px; }

    /* TABLE (desktop) */
    .tableWrap{
      overflow: hidden; /* no side-scroll */
      border-radius: 12px;
      border: 1px solid var(--line);
    }

    table{
      width:100%;
      border-collapse: collapse;
      background: rgba(15,21,18,0.55);
      table-layout: fixed; /* helps fit screen */
    }

    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(199,164,75,0.12);
      text-align: left;
      white-space: nowrap;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th{
      position: sticky; top:0;
      background: rgba(17,24,20,0.92);
      border-bottom: 1px solid rgba(199,164,75,0.25);
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      z-index: 2;
    }

    .habitCell{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .remove{
      background: transparent;
      border: 1px solid rgba(199,164,75,0.25);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 650;
      flex: 0 0 auto;
    }
    .remove:hover{ color: var(--text); border-color: rgba(199,164,75,0.55); }

    .chk{ width: 20px; height: 20px; accent-color: var(--gold); cursor:pointer; }

    .stats{ display:grid; gap: 12px; }

    .pill{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      padding: 12px 12px; border-radius: 14px;
      border: 1px solid rgba(199,164,75,0.18);
      background: rgba(17,24,20,0.55);
    }
    .pill b{ font-family: var(--mono); letter-spacing: 0.3px; }

    canvas{
      display:block; width:100%;
      background: rgba(15,21,18,0.35);
      border: 1px solid rgba(199,164,75,0.18);
      border-radius: 14px;
      padding: 10px;
    }

    .controls{
      display:flex; gap:10px; flex-wrap: wrap; align-items:center; justify-content:space-between;
      margin: 8px 0 12px;
    }

    .mutedBox{
      border: 1px solid rgba(199,164,75,0.18);
      background: rgba(17,24,20,0.35);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }

    .pctCol{
      font-family: var(--mono);
      color: var(--text);
    }

    /* PHONE: force “This Week” view (7 days only) so NO sideways scrolling */
    @media (max-width: 560px){
      .wrap{ margin: 16px auto; padding-bottom: 26px; }
      h1{ font-size: 22px; }
      input[type="text"]{ min-width: 160px; }
      .card{ padding: 12px; }

      /* make checkbox cells compact */
      th, td{ padding: 8px 8px; }
      .chk{ width: 18px; height: 18px; }

      /* keep first columns readable */
      th:nth-child(1), td:nth-child(1){ width: 44%; }
      th:nth-child(2), td:nth-child(2){ width: 10%; text-align: right; }

      /* day columns share remaining space */
      th:nth-child(n+3), td:nth-child(n+3){ text-align: center; }

      .remove{ padding: 5px 8px; }
      .sub{ font-size: 11px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>E-Girl OSK Consistency Chart</h1>
        <div class="sub">Minimal • no sideways scrolling • week view on mobile</div>
      </div>

      <div class="row">
        <input id="habitInput" type="text" placeholder="Add a habit (ex: Gym, Study, 8h sleep)" />
        <button id="addBtn">Add</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="controls">
          <div class="row">
            <button id="prevBtn">◀</button>
            <button id="nextBtn">▶</button>

            <select id="rangeSelect">
              <option value="week" selected>This week (Mon–Sun)</option>
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="180">Last 180 days</option>
              <option value="365">Last 365 days</option>
              <option value="all">All time</option>
            </select>

            <button id="todayBtn">Today</button>
            <button id="clearRangeBtn">Clear</button>
          </div>

          <div class="mutedBox" id="rangeText">Loading…</div>
        </div>

        <div class="tableWrap">
          <table id="habitTable">
            <thead>
              <tr id="headRow">
                <th>Habit</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="height:10px"></div>
        <div class="tiny">
          On phones, checkboxes always show the current week (Mon–Sun) so it fits perfectly.
          The range selector still changes your % + charts.
        </div>
      </div>

      <div class="card stats">
        <div class="pill">
          <div>
            <div class="tiny">Overall completion (selected range)</div>
            <b id="pctText">0%</b>
          </div>
          <div class="tiny" id="countsText">0 / 0</div>
        </div>

        <div>
          <div class="tiny" style="margin:0 0 8px;">Pie (done vs missing)</div>
          <canvas id="pieChart" height="220"></canvas>
        </div>

        <div>
          <div class="tiny" style="margin:0 0 8px;">Line (daily completion %)</div>
          <canvas id="lineChart" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "egirl_osk_consistency_chart_v2";

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { habits: [] };
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.habits)) return { habits: [] };

        parsed.habits = parsed.habits.map(h => ({
          name: String(h.name || "").trim(),
          checks: (h.checks && typeof h.checks === "object") ? h.checks : {}
        })).filter(h => h.name.length > 0);

        return parsed;
      }catch{
        return { habits: [] };
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    // DOM
    const habitInput = document.getElementById("habitInput");
    const addBtn = document.getElementById("addBtn");
    const tableBody = document.querySelector("#habitTable tbody");
    const headRow = document.getElementById("headRow");

    const pctText = document.getElementById("pctText");
    const countsText = document.getElementById("countsText");

    const rangeSelect = document.getElementById("rangeSelect");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const todayBtn = document.getElementById("todayBtn");
    const clearRangeBtn = document.getElementById("clearRangeBtn");
    const rangeText = document.getElementById("rangeText");

    // Date helpers
    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function fromISODate(s){
      const [y,m,d] = s.split("-").map(Number);
      return new Date(y, m-1, d);
    }
    function addDays(date, n){
      const d = new Date(date);
      d.setDate(d.getDate() + n);
      return d;
    }
    function fmtShort(iso){
      const d = fromISODate(iso);
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${mm}/${dd}`;
    }
    function todayISO(){ return toISODate(new Date()); }

    function makeDateList(startISO, endISO){
      const start = fromISODate(startISO);
      const end = fromISODate(endISO);
      const out = [];
      let cur = new Date(start);
      while(cur <= end){
        out.push(toISODate(cur));
        cur = addDays(cur, 1);
      }
      return out;
    }

    // Monday-start week (Mon -> Sun)
    function getWeekStartMonday(iso){
      const d = fromISODate(iso);
      const day = d.getDay(); // 0=Sun,1=Mon,...6=Sat
      const diffToMon = (day === 0) ? -6 : (1 - day);
      const mon = addDays(d, diffToMon);
      return toISODate(mon);
    }

    function getWeekDates(iso){
      const startISO = getWeekStartMonday(iso);
      const start = fromISODate(startISO);
      const endISO = toISODate(addDays(start, 6)); // Sun
      return { startISO, endISO, dates: makeDateList(startISO, endISO) };
    }

    function getAllDatesPresent(){
      const set = new Set();
      for(const h of state.habits){
        for(const k of Object.keys(h.checks || {})){
          set.add(k);
        }
      }
      const arr = Array.from(set);
      arr.sort();
      return arr;
    }

    // Selected range for STATS/CHARTS (can be long)
    let anchorISO = todayISO(); // used for prev/next + “today” alignment

    function getSelectedRange(){
      const v = rangeSelect.value;

      if(v === "week"){
        const w = getWeekDates(anchorISO);
        return { ...w, isAll:false, label:`This week: ${w.startISO} → ${w.endISO}` };
      }

      if(v === "all"){
        const all = getAllDatesPresent();
        if(all.length === 0){
          const w = getWeekDates(anchorISO);
          return { ...w, isAll:true, label:`All time: (no data yet) showing week ${w.startISO} → ${w.endISO}` };
        }
        const startISO = all[0];
        const endISO = (all[all.length-1] > anchorISO) ? all[all.length-1] : anchorISO;
        const dates = makeDateList(startISO, endISO);
        return { startISO, endISO, dates, isAll:true, label:`All time: ${startISO} → ${endISO}` };
      }

      const days = Number(v);
      const endISO = anchorISO;
      const startISO = toISODate(addDays(fromISODate(endISO), -(days-1)));
      const dates = makeDateList(startISO, endISO);
      return { startISO, endISO, dates, isAll:false, label:`Range: ${startISO} → ${endISO} (${days} days)` };
    }

    // Display range for CHECKBOX GRID (always week on small screens)
    function isPhone(){
      return window.matchMedia("(max-width: 560px)").matches;
    }

    function getDisplayDates(){
      // Always show “this week” in the grid so it fits the screen.
      const w = getWeekDates(anchorISO);
      return { ...w, label:`Week view: ${w.startISO} → ${w.endISO}` };
    }

    // Charts
    const pieCtx = document.getElementById("pieChart").getContext("2d");
    const lineCtx = document.getElementById("lineChart").getContext("2d");

    const pieChart = new Chart(pieCtx, {
      type: "doughnut",
      data: {
        labels: ["Done", "Missing"],
        datasets: [{
          data: [0,0],
          backgroundColor: ["rgba(199,164,75,0.85)", "rgba(42,106,79,0.55)"],
          borderColor: "rgba(199,164,75,0.25)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "#e7e4d8" } } }
      }
    });

    const lineChart = new Chart(lineCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Daily %",
          data: [],
          tension: 0.35,
          borderColor: "rgba(199,164,75,0.9)",
          backgroundColor: "rgba(199,164,75,0.15)",
          fill: true,
          pointRadius: 3,
          pointBackgroundColor: "rgba(199,164,75,0.9)"
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "#e7e4d8" } } },
        scales: {
          x: { ticks: { color: "#b9b29a" }, grid: { color: "rgba(199,164,75,0.10)" } },
          y: { ticks: { color: "#b9b29a" }, grid: { color: "rgba(199,164,75,0.10)" }, suggestedMin: 0, suggestedMax: 100 }
        }
      }
    });

    // Checks
    function getCheck(habit, iso){
      return !!(habit.checks && habit.checks[iso]);
    }
    function setCheck(habit, iso, val){
      if(!habit.checks) habit.checks = {};
      if(val) habit.checks[iso] = true;
      else delete habit.checks[iso];
    }

    function computeStatsForRange(dates){
      const habitsCount = state.habits.length;
      const totalBoxes = habitsCount * dates.length;

      let done = 0;
      const perDayDone = dates.map(() => 0);

      const perHabit = state.habits.map(h => {
        let hDone = 0;
        for(const iso of dates){
          if(getCheck(h, iso)) hDone++;
        }
        const pct = dates.length === 0 ? 0 : Math.round((hDone / dates.length) * 100);
        return { pct };
      });

      for(let hi = 0; hi < state.habits.length; hi++){
        const h = state.habits[hi];
        for(let di = 0; di < dates.length; di++){
          if(getCheck(h, dates[di])){
            done++;
            perDayDone[di]++;
          }
        }
      }

      const overallPct = totalBoxes === 0 ? 0 : Math.round((done / totalBoxes) * 100);
      const dailyPct = perDayDone.map(x => habitsCount === 0 ? 0 : Math.round((x / habitsCount) * 100));

      return { totalBoxes, done, overallPct, dailyPct, perHabit };
    }

    function updateCharts(selectedDates){
      const { totalBoxes, done, dailyPct } = computeStatsForRange(selectedDates);
      const missing = Math.max(0, totalBoxes - done);

      pieChart.data.datasets[0].data = [done, missing];
      pieChart.update();

      lineChart.data.labels = selectedDates.map(fmtShort);
      lineChart.data.datasets[0].data = dailyPct;
      lineChart.update();
    }

    function updateHeaderStats(selectedDates){
      const { totalBoxes, done, overallPct } = computeStatsForRange(selectedDates);
      pctText.textContent = `${overallPct}%`;
      countsText.textContent = `${done} / ${totalBoxes}`;
    }

    // Table
    function renderHeader(displayDates){
      headRow.innerHTML = "";

      const thHabit = document.createElement("th");
      thHabit.textContent = "Habit";
      headRow.appendChild(thHabit);

      const thPct = document.createElement("th");
      thPct.textContent = "%";
      headRow.appendChild(thPct);

      // Show weekday labels (Mon..Sun) so it matches what you asked for
      const labels = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      for(let i = 0; i < displayDates.length; i++){
        const th = document.createElement("th");
        th.textContent = labels[i];
        headRow.appendChild(th);
      }
    }

    function buildRow(habitIndex, displayDates, habitPct){
      const h = state.habits[habitIndex];
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      const wrap = document.createElement("div");
      wrap.className = "habitCell";

      const nameSpan = document.createElement("span");
      nameSpan.textContent = h.name;

      const removeBtn = document.createElement("button");
      removeBtn.className = "remove";
      removeBtn.textContent = "Remove";
      removeBtn.addEventListener("click", () => {
        state.habits.splice(habitIndex, 1);
        saveState();
        render();
      });

      wrap.appendChild(nameSpan);
      wrap.appendChild(removeBtn);
      nameTd.appendChild(wrap);
      tr.appendChild(nameTd);

      const pctTd = document.createElement("td");
      pctTd.className = "pctCol";
      pctTd.textContent = `${habitPct}%`;
      tr.appendChild(pctTd);

      for(const iso of displayDates){
        const td = document.createElement("td");
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "chk";
        chk.checked = getCheck(h, iso);

        chk.addEventListener("change", () => {
          setCheck(state.habits[habitIndex], iso, chk.checked);
          saveState();
          render();
        });

        td.appendChild(chk);
        tr.appendChild(td);
      }

      return tr;
    }

    function renderTable(displayDates, perHabitPctFromSelectedRange){
      tableBody.innerHTML = "";

      state.habits.forEach((_, idx) => {
        const pct = perHabitPctFromSelectedRange[idx] ? perHabitPctFromSelectedRange[idx].pct : 0;
        tableBody.appendChild(buildRow(idx, displayDates, pct));
      });
    }

    function render(){
      // RANGE for percent + charts
      const selected = getSelectedRange();
      const selectedStats = computeStatsForRange(selected.dates);

      // DISPLAY for checkbox grid (always Mon–Sun week view)
      const display = getDisplayDates();

      // top text
      rangeText.textContent = `${selected.label} • Grid shows ${display.label}`;

      renderHeader(display.dates);
      renderTable(display.dates, selectedStats.perHabit);
      updateHeaderStats(selected.dates);
      updateCharts(selected.dates);
    }

    // Actions
    function addHabit(){
      const name = habitInput.value.trim();
      if(!name) return;

      const exists = state.habits.some(h => h.name.toLowerCase() === name.toLowerCase());
      if(exists){
        habitInput.value = "";
        habitInput.focus();
        return;
      }

      state.habits.push({ name, checks: {} });
      habitInput.value = "";
      habitInput.focus();
      saveState();
      render();
    }

    function shiftAnchor(days){
      anchorISO = toISODate(addDays(fromISODate(anchorISO), days));
      render();
    }

    function clearSelectedRange(){
      const selected = getSelectedRange();
      for(const h of state.habits){
        for(const iso of selected.dates){
          setCheck(h, iso, false);
        }
      }
      saveState();
      render();
    }

    // Events
    addBtn.addEventListener("click", addHabit);
    habitInput.addEventListener("keydown", (e) => { if(e.key === "Enter") addHabit(); });

    rangeSelect.addEventListener("change", render);

    prevBtn.addEventListener("click", () => {
      const v = rangeSelect.value;
      if(v === "week") return shiftAnchor(-7);
      if(v === "all") return shiftAnchor(-31);
      return shiftAnchor(-Number(v));
    });

    nextBtn.addEventListener("click", () => {
      const v = rangeSelect.value;
      if(v === "week") return shiftAnchor(7);
      if(v === "all") return shiftAnchor(31);
      return shiftAnchor(Number(v));
    });

    todayBtn.addEventListener("click", () => {
      anchorISO = todayISO();
      render();
    });

    clearRangeBtn.addEventListener("click", clearSelectedRange);

    // Re-render when screen rotates / resizes
    window.addEventListener("resize", () => render());

    // Init (today, and week view by default)
    anchorISO = todayISO();
    rangeSelect.value = "week";
    render();
  </script>
</body>
</html>
