<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>CCC</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b0f0d" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="CCC" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #0b0f0d;
      --card: rgba(17,24,20,0.72);
      --card2: rgba(15,21,18,0.75);
      --text: #e7e4d8;
      --muted: #b9b29a;
      --premium: #9aa6a0; /* premium accent (no gold) */
      --green: #2a6a4f;
      --line: rgba(154,166,160,0.18);
      --shadow: 0 10px 30px rgba(0,0,0,0.45);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    html, body{ height: 100%; }
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(42,106,79,0.25), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(154,166,160,0.16), transparent 60%),
        var(--bg);
      color: var(--text);
    }

    .wrap{ max-width: 1200px; margin: 18px auto; padding: 0 14px 26px; }
    .top{
      display:flex; gap:14px; align-items:flex-end; justify-content:space-between; flex-wrap: wrap;
      margin-bottom: 12px;
    }
    h1{ margin:0; font-weight: 800; letter-spacing: 0.4px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow: hidden; /* prevents any accidental sideways */
    }

    .grid{ display:grid; grid-template-columns: 1.25fr 0.75fr; gap: 14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .row{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }

    input[type="text"], select, input[type="date"]{
      background: var(--card2);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      max-width: 100%;
    }
    input[type="text"]{ min-width: 200px; flex: 1; }

    button{
      background: linear-gradient(180deg, rgba(154,166,160,0.18), rgba(154,166,160,0.08));
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 700;
      white-space: nowrap;
    }
    button:hover{ border-color: rgba(154,166,160,0.40); }
    button:disabled{ opacity: 0.55; cursor: not-allowed; }

    .tiny{ color: var(--muted); font-size: 12px; }

    /* NO sideways scroll: the grid uses 7 columns on mobile, and a capped number on desktop */
    .tableWrap{
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--line);
      overflow: hidden;
    }
    table{
      width:100%;
      border-collapse: collapse;
      background: rgba(15,21,18,0.55);
      table-layout: fixed; /* critical: prevents width explosion */
    }

    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(154,166,160,0.10);
      text-align: center;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    th{
      background: rgba(17,24,20,0.92);
      border-bottom: 1px solid rgba(154,166,160,0.22);
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    th.habitCol, td.habitCol{
      text-align: left;
      width: 34%;
    }
    th.pctCol, td.pctCol{
      width: 10%;
      font-family: var(--mono);
    }

    .habitCell{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }

    .remove{
      background: transparent;
      border: 1px solid rgba(154,166,160,0.20);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 750;
    }
    .remove:hover{ color: var(--text); border-color: rgba(154,166,160,0.45); }

    .chk{ width: 20px; height: 20px; accent-color: var(--premium); cursor:pointer; }

    .stats{ display:grid; gap: 12px; }
    .pill{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      padding: 12px; border-radius: 14px;
      border: 1px solid rgba(154,166,160,0.16);
      background: rgba(17,24,20,0.55);
    }
    .pill b{ font-family: var(--mono); letter-spacing: 0.3px; font-size: 18px; }

    .chartBox{
      border: 1px solid rgba(154,166,160,0.16);
      border-radius: 14px;
      background: rgba(15,21,18,0.35);
      padding: 10px;
      overflow: hidden;
    }

    /* LOCK chart sizes (prevents “screen gets bigger”) */
    .chartFixed{ height: 220px; }
    canvas{ width:100% !important; height:100% !important; display:block; }

    .controls{
      display:flex; gap:10px; flex-wrap: wrap; align-items:center; justify-content:space-between;
      margin: 8px 0 12px;
    }

    .mutedBox{
      border: 1px solid rgba(154,166,160,0.16);
      background: rgba(17,24,20,0.35);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Mobile: clean and readable */
    @media (max-width: 520px){
      .wrap{ margin: 14px auto; padding-bottom: 22px; }
      h1{ font-size: 22px; }
      th.habitCol, td.habitCol{ width: 44%; }
      th.pctCol, td.pctCol{ width: 12%; }
      th, td{ padding: 10px 6px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Commitment Consistency Chart</h1>
      </div>

      <div class="row">
        <input id="habitInput" type="text" placeholder="Add a habit (Gym, Study, Sleep)" />
        <button id="addBtn">Add</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="controls">
          <div class="row">
            <button id="prevBtn">◀ Prev</button>
            <button id="nextBtn">Next ▶</button>

            <select id="rangeSelect">
              <option value="week" selected>This week</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="all">All time</option>
            </select>

            <button id="todayBtn">Today</button>
          </div>

          <div class="mutedBox" id="rangeText">Loading…</div>
        </div>

        <div class="tableWrap">
          <table id="habitTable">
            <thead>
              <tr id="headRow"></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="height:10px"></div>
        <div class="tiny" id="gridTip"></div>
      </div>

      <div class="card stats">
        <div class="pill">
          <div>
            <div class="tiny">Range completion</div>
            <b id="pctText">0%</b>
          </div>
          <div class="tiny" id="countsText">0 / 0</div>
        </div>

        <div>
          <div class="tiny" style="margin:0 0 8px;">All-time consistency</div>
          <div class="chartBox chartFixed">
            <canvas id="pieChart"></canvas>
          </div>
        </div>

        <div>
          <div class="tiny" style="margin:0 0 8px;">Daily completion % (range)</div>
          <div class="chartBox chartFixed">
            <canvas id="lineChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- PWA SW ---
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
    }

    const STORAGE_KEY = "ccc_consistency_v2";

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { habits: [] };
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.habits)) return { habits: [] };

        parsed.habits = parsed.habits.map(h => ({
          name: String(h.name || "").trim(),
          checks: (h.checks && typeof h.checks === "object") ? h.checks : {}
        })).filter(h => h.name.length > 0);

        return parsed;
      }catch{
        return { habits: [] };
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    // DOM
    const habitInput = document.getElementById("habitInput");
    const addBtn = document.getElementById("addBtn");
    const tableBody = document.querySelector("#habitTable tbody");
    const headRow = document.getElementById("headRow");

    const pctText = document.getElementById("pctText");
    const countsText = document.getElementById("countsText");

    const rangeSelect = document.getElementById("rangeSelect");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const todayBtn = document.getElementById("todayBtn");
    const rangeText = document.getElementById("rangeText");
    const gridTip = document.getElementById("gridTip");

    const isMobile = window.matchMedia("(max-width: 520px)").matches;

    // Date helpers
    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function fromISODate(s){
      const [y,m,d] = s.split("-").map(Number);
      return new Date(y, m-1, d);
    }
    function addDays(date, n){
      const d = new Date(date);
      d.setDate(d.getDate() + n);
      return d;
    }
    function todayISO(){ return toISODate(new Date()); }

    // Monday-start week
    function startOfWeekMonday(date){
      const d = new Date(date);
      const day = d.getDay(); // Sun=0
      const diff = (day === 0) ? -6 : (1 - day); // move to Monday
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function makeDateList(startISO, endISO){
      const start = fromISODate(startISO);
      const end = fromISODate(endISO);
      const out = [];
      let cur = new Date(start);
      while(cur <= end){
        out.push(toISODate(cur));
        cur = addDays(cur, 1);
      }
      return out;
    }

    function getAllDatesPresent(){
      const set = new Set();
      for(const h of state.habits){
        for(const k of Object.keys(h.checks || {})){
          set.add(k);
        }
      }
      const arr = Array.from(set);
      arr.sort();
      return arr;
    }

    // Fixed “today” end
    let endISO = todayISO();

    function getRange(){
      // Mobile is always week (no chaos)
      if(isMobile){
        rangeSelect.value = "week";
        rangeSelect.disabled = true;
      }

      const end = fromISODate(endISO);
      const v = rangeSelect.value;

      if(v === "week"){
        const start = startOfWeekMonday(end);
        const startISO = toISODate(start);
        const endOfWeek = addDays(start, 6);
        const endWeekISO = toISODate(endOfWeek);
        const dates = makeDateList(startISO, endWeekISO);
        return { label: "This week", startISO, endISO: endWeekISO, dates, gridDates: dates, isAll:false };
      }

      if(v === "all"){
        const all = getAllDatesPresent();
        if(all.length === 0){
          const start = addDays(end, -6);
          const startISO = toISODate(start);
          const dates = makeDateList(startISO, endISO);
          return { label: "All time", startISO, endISO, dates, gridDates: dates, isAll:true };
        }
        const startISO = all[0];
        const lastISO = all[all.length-1];
        const realEnd = (lastISO > endISO) ? lastISO : endISO;
        const dates = makeDateList(startISO, realEnd);
        // Grid stays readable: show last 14 days on desktop, week on mobile
        const gridDates = isMobile ? dates.slice(-7) : dates.slice(-14);
        return { label: "All time", startISO, endISO: realEnd, dates, gridDates, isAll:true };
      }

      const days = Number(v);
      const start = addDays(end, -(days-1));
      const startISO = toISODate(start);
      const dates = makeDateList(startISO, endISO);

      // Grid cap: week on mobile, last 14 on desktop (prevents screen “growing”)
      const gridDates = isMobile ? dates.slice(-7) : dates.slice(-14);

      return { label: `Last ${days} days`, startISO, endISO, dates, gridDates, isAll:false };
    }

    // Checks
    function getCheck(habit, iso){
      return !!(habit.checks && habit.checks[iso]);
    }
    function setCheck(habit, iso, val){
      if(!habit.checks) habit.checks = {};
      if(val) habit.checks[iso] = true;
      else delete habit.checks[iso];
    }

    function computeStatsForRange(dates){
      const habitsCount = state.habits.length;
      const totalBoxes = habitsCount * dates.length;

      let done = 0;
      const perDayDone = dates.map(() => 0);

      const perHabit = state.habits.map(h => {
        let hDone = 0;
        for(const iso of dates){
          if(getCheck(h, iso)) hDone++;
        }
        const pct = dates.length === 0 ? 0 : Math.round((hDone / dates.length) * 100);
        return { pct };
      });

      for(let hi = 0; hi < state.habits.length; hi++){
        const h = state.habits[hi];
        for(let di = 0; di < dates.length; di++){
          if(getCheck(h, dates[di])){
            done++;
            perDayDone[di]++;
          }
        }
      }

      const overallPct = totalBoxes === 0 ? 0 : Math.round((done / totalBoxes) * 100);
      const dailyPct = perDayDone.map(x => habitsCount === 0 ? 0 : Math.round((x / habitsCount) * 100));

      return { totalBoxes, done, overallPct, dailyPct, perHabit };
    }

    function computeAllTimeStats(){
      const dates = getAllDatesPresent();
      return computeStatsForRange(dates);
    }

    function dayLabel(iso){
      const d = fromISODate(iso);
      const names = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      return `${names[d.getDay()]} ${mm}/${dd}`;
    }

    // Charts
    const pieCtx = document.getElementById("pieChart").getContext("2d");
    const lineCtx = document.getElementById("lineChart").getContext("2d");

    const pieChart = new Chart(pieCtx, {
      type: "doughnut",
      data: {
        labels: ["Done", "Missing"],
        datasets: [{
          data: [0,0],
          backgroundColor: ["rgba(154,166,160,0.85)", "rgba(42,106,79,0.55)"],
          borderColor: "rgba(154,166,160,0.20)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: "#e7e4d8" } } }
      }
    });

    const lineChart = new Chart(lineCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Daily %",
          data: [],
          tension: 0.35,
          borderColor: "rgba(154,166,160,0.9)",
          backgroundColor: "rgba(154,166,160,0.12)",
          fill: true,
          pointRadius: 3,
          pointBackgroundColor: "rgba(154,166,160,0.9)"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: "#e7e4d8" } } },
        scales: {
          x: { ticks: { color: "#b9b29a" }, grid: { color: "rgba(154,166,160,0.08)" } },
          y: { ticks: { color: "#b9b29a" }, grid: { color: "rgba(154,166,160,0.08)" }, suggestedMin: 0, suggestedMax: 100 }
        }
      }
    });

    function updateAllTimePie(){
      const { totalBoxes, done } = computeAllTimeStats();
      const missing = Math.max(0, totalBoxes - done);
      pieChart.data.datasets[0].data = [done, missing];
      pieChart.update();
    }

    function updateRangeLine(dates){
      const { dailyPct } = computeStatsForRange(dates);
      lineChart.data.labels = dates.map(d => dayLabel(d).split(" ")[0]); // Mon Tue...
      lineChart.data.datasets[0].data = dailyPct;
      lineChart.update();
    }

    function updateHeaderStats(dates){
      const { totalBoxes, done, overallPct } = computeStatsForRange(dates);
      pctText.textContent = `${overallPct}%`;
      countsText.textContent = `${done} / ${totalBoxes}`;
    }

    // Table
    function renderHeader(gridDates){
      headRow.innerHTML = "";

      const thHabit = document.createElement("th");
      thHabit.className = "habitCol";
      thHabit.textContent = "Habit";
      headRow.appendChild(thHabit);

      const thPct = document.createElement("th");
      thPct.className = "pctCol";
      thPct.textContent = "%";
      headRow.appendChild(thPct);

      for(const iso of gridDates){
        const th = document.createElement("th");
        th.textContent = dayLabel(iso);
        headRow.appendChild(th);
      }
    }

    function buildRow(habitIndex, gridDates, habitPct){
      const h = state.habits[habitIndex];
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      nameTd.className = "habitCol";
      const wrap = document.createElement("div");
      wrap.className = "habitCell";

      const nameSpan = document.createElement("span");
      nameSpan.textContent = h.name;

      const removeBtn = document.createElement("button");
      removeBtn.className = "remove";
      removeBtn.textContent = "Remove";
      removeBtn.addEventListener("click", () => {
        state.habits.splice(habitIndex, 1);
        saveState();
        render();
      });

      wrap.appendChild(nameSpan);
      wrap.appendChild(removeBtn);
      nameTd.appendChild(wrap);
      tr.appendChild(nameTd);

      const pctTd = document.createElement("td");
      pctTd.className = "pctCol";
      pctTd.textContent = `${habitPct}%`;
      tr.appendChild(pctTd);

      for(const iso of gridDates){
        const td = document.createElement("td");
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "chk";
        chk.checked = getCheck(h, iso);

        chk.addEventListener("change", () => {
          setCheck(state.habits[habitIndex], iso, chk.checked);
          saveState();
          // IMPORTANT: pie is all-time, so updating it here is fine
          updateAllTimePie();
          render();
        });

        td.appendChild(chk);
        tr.appendChild(td);
      }

      return tr;
    }

    function renderTable(rangeDates, gridDates){
      tableBody.innerHTML = "";
      const stats = computeStatsForRange(rangeDates);

      state.habits.forEach((_, idx) => {
        const pct = stats.perHabit[idx] ? stats.perHabit[idx].pct : 0;
        tableBody.appendChild(buildRow(idx, gridDates, pct));
      });
    }

    function render(){
      const r = getRange();

      // Display text (simple, not messy)
      rangeText.textContent = `${r.label} • Week starts Monday • Today: ${todayISO()}`;

      // Tip: explain grid caps (without being annoying)
      if(r.gridDates.length < r.dates.length){
        gridTip.textContent = `Grid shows last ${r.gridDates.length} days (stats use full range).`;
      } else {
        gridTip.textContent = "";
      }

      renderHeader(r.gridDates);
      renderTable(r.dates, r.gridDates);

      updateHeaderStats(r.dates);
      updateRangeLine(r.gridDates);   // line uses visible grid
      updateAllTimePie();             // pie is ALWAYS all-time
    }

    // Actions
    function addHabit(){
      const name = habitInput.value.trim();
      if(!name) return;

      const exists = state.habits.some(h => h.name.toLowerCase() === name.toLowerCase());
      if(exists){
        habitInput.value = "";
        habitInput.focus();
        return;
      }

      state.habits.push({ name, checks: {} });
      habitInput.value = "";
      habitInput.focus();
      saveState();
      updateAllTimePie();
      render();
    }

    function shiftRange(step){
      const end = fromISODate(endISO);
      const moved = addDays(end, step);
      endISO = toISODate(moved);
      render();
    }

    addBtn.addEventListener("click", addHabit);
    habitInput.addEventListener("keydown", (e) => { if(e.key === "Enter") addHabit(); });

    rangeSelect.addEventListener("change", render);

    prevBtn.addEventListener("click", () => {
      const v = rangeSelect.value;
      if(v === "week") shiftRange(-7);
      else if(v === "all") shiftRange(-14);
      else shiftRange(-Number(v));
    });

    nextBtn.addEventListener("click", () => {
      const v = rangeSelect.value;
      if(v === "week") shiftRange(7);
      else if(v === "all") shiftRange(14);
      else shiftRange(Number(v));
    });

    todayBtn.addEventListener("click", () => {
      endISO = todayISO();
      render();
    });

    // Init
    if(isMobile){
      rangeSelect.value = "week";
      rangeSelect.disabled = true;
    }
    render();
  </script>
</body>
</html>
