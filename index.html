<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Commitment Consistency Chart</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b0f0d" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="CCC" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #0b0f0d;
      --card: #111814;
      --card2: #0f1512;
      --text: #e7e4d8;
      --muted: #b9b29a;
      --gold: #c7a44b;
      --green: #2a6a4f;
      --line: rgba(199,164,75,0.25);
      --shadow: 0 10px 30px rgba(0,0,0,0.45);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    html, body{ height: 100%; }

    body{
      margin:0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(42,106,79,0.25), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(199,164,75,0.18), transparent 60%),
        var(--bg);
      color: var(--text);
    }

    .wrap{ max-width: 1200px; margin: 28px auto; padding: 0 16px 40px; }

    .top{
      display:flex; gap:16px; align-items:flex-end; justify-content:space-between; flex-wrap: wrap;
      margin-bottom: 12px;
    }

    h1{ margin:0; font-weight: 750; letter-spacing: 0.3px; }
    .sub{ margin:6px 0 0; color: var(--muted); font-family: var(--mono); font-size: 12px; display:none; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .grid{ display:grid; grid-template-columns: 1.25fr 0.75fr; gap: 16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .row{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }

    input[type="text"], select, input[type="date"]{
      background: var(--card2);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    input[type="text"]{ min-width: 240px; flex: 1; }

    button{
      background: linear-gradient(180deg, rgba(199,164,75,0.22), rgba(199,164,75,0.10));
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 650;
    }
    button:hover{ border-color: rgba(199,164,75,0.55); }

    .tiny{ color: var(--muted); font-size: 12px; }

    .tableWrap{
      overflow:auto;
      border-radius: 12px;
      border: 1px solid var(--line);
    }

    table{
      width:100%;
      border-collapse: collapse;
      min-width: 860px;
      background: rgba(15,21,18,0.55);
    }

    th, td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(199,164,75,0.12);
      text-align: left;
      white-space: nowrap;
      vertical-align: middle;
    }

    th{
      position: sticky; top:0;
      background: rgba(17,24,20,0.92);
      border-bottom: 1px solid rgba(199,164,75,0.25);
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      z-index: 2;
    }

    .habitCell{ display:flex; gap:10px; align-items:center; justify-content:space-between; min-width: 260px; }
    .remove{
      background: transparent;
      border: 1px solid rgba(199,164,75,0.25);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 650;
    }
    .remove:hover{ color: var(--text); border-color: rgba(199,164,75,0.55); }

    .chk{ width: 20px; height: 20px; accent-color: var(--gold); cursor:pointer; }

    .stats{ display:grid; gap: 12px; }

    .pill{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      padding: 12px 12px; border-radius: 14px;
      border: 1px solid rgba(199,164,75,0.18);
      background: rgba(17,24,20,0.55);
    }
    .pill b{ font-family: var(--mono); letter-spacing: 0.3px; }

    canvas{
      display:block; width:100%;
      background: rgba(15,21,18,0.35);
      border: 1px solid rgba(199,164,75,0.18);
      border-radius: 14px;
      padding: 10px;
    }

    .controls{
      display:flex; gap:10px; flex-wrap: wrap; align-items:center; justify-content:space-between;
      margin: 10px 0 14px;
    }

    .mutedBox{
      border: 1px solid rgba(199,164,75,0.18);
      background: rgba(17,24,20,0.35);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }

    .pctCol{
      font-family: var(--mono);
      color: var(--text);
    }

    /* Phone polish */
    @media (max-width: 520px){
      .wrap{ margin: 18px auto; padding-bottom: 28px; }
      h1{ font-size: 22px; }
      input[type="text"]{ min-width: 180px; }
      table{ min-width: 720px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Commitment Consistency Chart</h1>
      </div>

      <div class="row">
        <input id="habitInput" type="text" placeholder="Add a habit (ex: Gym, Study, 8h sleep)" />
        <button id="addBtn">Add</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="controls">
          <div class="row">
            <button id="prevBtn">◀ Prev</button>
            <button id="nextBtn">Next ▶</button>

            <select id="rangeSelect">
              <option value="7" selected>This week</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="180">Last 180 days</option>
              <option value="365">Last 365 days</option>
              <option value="all">All time</option>
            </select>

            <div class="row">
              <span class="tiny">End date:</span>
              <input id="endDate" type="date" />
            </div>

            <button id="todayBtn">Today</button>
            <button id="clearRangeBtn">Clear Range</button>
          </div>

          <div class="mutedBox" id="rangeText">Loading…</div>
        </div>

        <div class="tableWrap">
          <table id="habitTable">
            <thead>
              <tr id="headRow">
                <th>Habit</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card stats">
        <div class="pill">
          <div>
            <div class="tiny">Overall completion (selected range)</div>
            <b id="pctText">0%</b>
          </div>
          <div class="tiny" id="countsText">0 / 0</div>
        </div>

        <div>
          <div class="tiny" style="margin:0 0 8px;">Pie (done vs missing)</div>
          <canvas id="pieChart" height="220"></canvas>
        </div>

        <div>
          <div class="tiny" style="margin:0 0 8px;">Line (daily completion %)</div>
          <canvas id="lineChart" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "ccc_commitment_consistency_chart_v1";

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { habits: [] };
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.habits)) return { habits: [] };

        parsed.habits = parsed.habits.map(h => ({
          name: String(h.name || "").trim(),
          checks: (h.checks && typeof h.checks === "object") ? h.checks : {}
        })).filter(h => h.name.length > 0);

        return parsed;
      }catch{
        return { habits: [] };
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    // DOM
    const habitInput = document.getElementById("habitInput");
    const addBtn = document.getElementById("addBtn");
    const tableBody = document.querySelector("#habitTable tbody");
    const headRow = document.getElementById("headRow");

    const pctText = document.getElementById("pctText");
    const countsText = document.getElementById("countsText");

    const rangeSelect = document.getElementById("rangeSelect");
    const endDateEl = document.getElementById("endDate");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const todayBtn = document.getElementById("todayBtn");
    const clearRangeBtn = document.getElementById("clearRangeBtn");
    const rangeText = document.getElementById("rangeText");

    // Date helpers
    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function fromISODate(s){
      const [y,m,d] = s.split("-").map(Number);
      return new Date(y, m-1, d);
    }
    function addDays(date, n){
      const d = new Date(date);
      d.setDate(d.getDate() + n);
      return d;
    }
    function fmtShort(iso){
      const d = fromISODate(iso);
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${mm}/${dd}`;
    }
    function todayISO(){ return toISODate(new Date()); }

    function startOfWeekISO(endISO){
      const d = fromISODate(endISO);
      // Monday-based week: Mon=0 ... Sun=6
      const day = d.getDay(); // Sun=0..Sat=6
      const monBased = (day + 6) % 7;
      const start = addDays(d, -monBased);
      return toISODate(start);
    }

    function getAllDatesPresent(){
      const set = new Set();
      for(const h of state.habits){
        for(const k of Object.keys(h.checks || {})){
          set.add(k);
        }
      }
      const arr = Array.from(set);
      arr.sort();
      return arr;
    }

    function makeDateList(startISO, endISO){
      const start = fromISODate(startISO);
      const end = fromISODate(endISO);
      const out = [];
      let cur = new Date(start);
      while(cur <= end){
        out.push(toISODate(cur));
        cur = addDays(cur, 1);
      }
      return out;
    }

    function getRange(){
      const endISO = endDateEl.value || todayISO();
      const end = fromISODate(endISO);
      const rangeVal = rangeSelect.value;

      if(rangeVal === "7"){
        const startISO = startOfWeekISO(endISO);
        const endISO2 = toISODate(addDays(fromISODate(startISO), 6));
        const dates = makeDateList(startISO, endISO2);
        return { startISO, endISO: endISO2, dates, mode: "week" };
      }

      if(rangeVal === "all"){
        const all = getAllDatesPresent();
        if(all.length === 0){
          const start = addDays(end, -6);
          const startISO = toISODate(start);
          const dates = makeDateList(startISO, endISO);
          return { startISO, endISO, dates, mode: "all" };
        }
        const startISO = all[0];
        const lastISO = all[all.length-1];
        const endISO2 = (lastISO > endISO) ? lastISO : endISO;

        const fullDates = makeDateList(startISO, endISO2);
        const dates = fullDates.slice(-31);
        return { startISO, endISO: endISO2, dates, mode: "all" };
      }

      const days = Number(rangeVal);
      const start = addDays(end, -(days-1));
      const startISO = toISODate(start);
      const dates = makeDateList(startISO, endISO);
      return { startISO, endISO, dates, mode: "range" };
    }

    // Charts
    const pieCtx = document.getElementById("pieChart").getContext("2d");
    const lineCtx = document.getElementById("lineChart").getContext("2d");

    const pieChart = new Chart(pieCtx, {
      type: "doughnut",
      data: {
        labels: ["Done", "Missing"],
        datasets: [{
          data: [0,0],
          backgroundColor: ["rgba(199,164,75,0.85)", "rgba(42,106,79,0.55)"],
          borderColor: "rgba(199,164,75,0.25)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "#e7e4d8" } } }
      }
    });

    const lineChart = new Chart(lineCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Daily %",
          data: [],
          tension: 0.35,
          borderColor: "rgba(199,164,75,0.9)",
          backgroundColor: "rgba(199,164,75,0.15)",
          fill: true,
          pointRadius: 3,
          pointBackgroundColor: "rgba(199,164,75,0.9)"
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "#e7e4d8" } } },
        scales: {
          x: { ticks: { color: "#b9b29a" }, grid: { color: "rgba(199,164,75,0.10)" } },
          y: { ticks: { color: "#b9b29a" }, grid: { color: "rgba(199,164,75,0.10)" }, suggestedMin: 0, suggestedMax: 100 }
        }
      }
    });

    // Checks
    function getCheck(habit, iso){
      return !!(habit.checks && habit.checks[iso]);
    }
    function setCheck(habit, iso, val){
      if(!habit.checks) habit.checks = {};
      if(val) habit.checks[iso] = true;
      else delete habit.checks[iso];
    }

    function computeStatsForRange(dates){
      const habitsCount = state.habits.length;
      const totalBoxes = habitsCount * dates.length;

      let done = 0;
      const perDayDone = dates.map(() => 0);

      const perHabit = state.habits.map(h => {
        let hDone = 0;
        for(const iso of dates){
          if(getCheck(h, iso)) hDone++;
        }
        const pct = dates.length === 0 ? 0 : Math.round((hDone / dates.length) * 100);
        return { pct };
      });

      for(let hi = 0; hi < state.habits.length; hi++){
        const h = state.habits[hi];
        for(let di = 0; di < dates.length; di++){
          if(getCheck(h, dates[di])){
            done++;
            perDayDone[di]++;
          }
        }
      }

      const overallPct = totalBoxes === 0 ? 0 : Math.round((done / totalBoxes) * 100);
      const dailyPct = perDayDone.map(x => habitsCount === 0 ? 0 : Math.round((x / habitsCount) * 100));

      return { totalBoxes, done, overallPct, dailyPct, perHabit };
    }

    function updateCharts(dates){
      const { totalBoxes, done, dailyPct } = computeStatsForRange(dates);
      const missing = Math.max(0, totalBoxes - done);

      pieChart.data.datasets[0].data = [done, missing];
      pieChart.update();

      lineChart.data.labels = dates.map(fmtShort);
      lineChart.data.datasets[0].data = dailyPct;
      lineChart.update();
    }

    function updateHeaderStats(dates){
      const { totalBoxes, done, overallPct } = computeStatsForRange(dates);
      pctText.textContent = `${overallPct}%`;
      countsText.textContent = `${done} / ${totalBoxes}`;
    }

    // Table (Day + Date in week view)
    function renderHeader(dates){
      headRow.innerHTML = "";

      const thHabit = document.createElement("th");
      thHabit.textContent = "Habit";
      headRow.appendChild(thHabit);

      const thPct = document.createElement("th");
      thPct.textContent = "%";
      headRow.appendChild(thPct);

      const isWeekView = dates.length <= 7;

      for(const iso of dates){
        const th = document.createElement("th");

        if(isWeekView){
          const d = fromISODate(iso);
          const day = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
          th.textContent = `${day} ${fmtShort(iso)}`; // Mon 01/19
        } else {
          th.textContent = fmtShort(iso); // 01/19
        }

        headRow.appendChild(th);
      }
    }

    function buildRow(habitIndex, dates, habitPct){
      const h = state.habits[habitIndex];
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      const wrap = document.createElement("div");
      wrap.className = "habitCell";

      const nameSpan = document.createElement("span");
      nameSpan.textContent = h.name;

      const removeBtn = document.createElement("button");
      removeBtn.className = "remove";
      removeBtn.textContent = "Remove";
      removeBtn.addEventListener("click", () => {
        state.habits.splice(habitIndex, 1);
        saveState();
        render();
      });

      wrap.appendChild(nameSpan);
      wrap.appendChild(removeBtn);
      nameTd.appendChild(wrap);
      tr.appendChild(nameTd);

      const pctTd = document.createElement("td");
      pctTd.className = "pctCol";
      pctTd.textContent = `${habitPct}%`;
      tr.appendChild(pctTd);

      for(const iso of dates){
        const td = document.createElement("td");
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "chk";
        chk.checked = getCheck(h, iso);

        chk.addEventListener("change", () => {
          setCheck(state.habits[habitIndex], iso, chk.checked);
          saveState();
          render();
        });

        td.appendChild(chk);
        tr.appendChild(td);
      }

      return tr;
    }

    function renderTable(dates){
      tableBody.innerHTML = "";
      const stats = computeStatsForRange(dates);

      state.habits.forEach((_, idx) => {
        const pct = stats.perHabit[idx] ? stats.perHabit[idx].pct : 0;
        tableBody.appendChild(buildRow(idx, dates, pct));
      });
    }

    function render(){
      const { startISO, endISO, dates, mode } = getRange();

      // simple, not repeating
      if(mode === "week"){
        rangeText.textContent = `Week: ${startISO} → ${endISO}`;
      } else if(mode === "all"){
        rangeText.textContent = `All time: ${startISO} → ${endISO}`;
      } else {
        rangeText.textContent = `Range: ${startISO} → ${endISO}`;
      }

      renderHeader(dates);
      renderTable(dates);
      updateHeaderStats(dates);
      updateCharts(dates);
    }

    // Actions
    function addHabit(){
      const name = habitInput.value.trim();
      if(!name) return;

      const exists = state.habits.some(h => h.name.toLowerCase() === name.toLowerCase());
      if(exists){
        habitInput.value = "";
        habitInput.focus();
        return;
      }

      state.habits.push({ name, checks: {} });
      habitInput.value = "";
      habitInput.focus();
      saveState();
      render();
    }

    function shiftRange(days){
      const cur = endDateEl.value || todayISO();
      const next = toISODate(addDays(fromISODate(cur), days));
      endDateEl.value = next;
      render();
    }

    function clearRange(){
      const { dates } = getRange();
      for(const h of state.habits){
        for(const iso of dates){
          setCheck(h, iso, false);
        }
      }
      saveState();
      render();
    }

    // Events
    addBtn.addEventListener("click", addHabit);
    habitInput.addEventListener("keydown", (e) => { if(e.key === "Enter") addHabit(); });

    rangeSelect.addEventListener("change", render);
    endDateEl.addEventListener("change", render);

    prevBtn.addEventListener("click", () => {
      const v = rangeSelect.value;
      const n = (v === "all") ? 31 : (v === "7" ? 7 : Number(v));
      shiftRange(-n);
    });
    nextBtn.addEventListener("click", () => {
      const v = rangeSelect.value;
      const n = (v === "all") ? 31 : (v === "7" ? 7 : Number(v));
      shiftRange(n);
    });

    todayBtn.addEventListener("click", () => {
      endDateEl.value = todayISO();
      render();
    });

    clearRangeBtn.addEventListener("click", clearRange);

    // Init
    endDateEl.value = endDateEl.value || todayISO();
    render();
  </script>
</body>
</html>
